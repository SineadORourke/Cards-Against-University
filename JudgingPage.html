<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    

    <title>Judging</title>
	<link rel="stylesheet" href="cauStyle.css">
	
	<!-- Firebase Library -->
	<script src='https://cdn.firebase.com/js/client/2.4.1/firebase.js'></script>

	<!--Disable Back Button -->
    <script type="text/javascript">
        window.history.forward();
        function noBack()
        {
            window.history.forward();
        }
    </script>
    <style>
      #bCard {
        margin-top:2%;
        left:8.5%;
      }

      .modal-dialog{
        position: absolute;
        top: 50%;
        } 
    </style>

	<!--Links for Bootstrap-->
    <meta charset="utf-8"> 
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<link rel="stylesheet" href="cauStyle.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

	</head>
	
	
	
	
<body data-spy="scroll" data-target=".navbar" data-offset="50" id="main" onLoad="noBack();" onpageshow="if (event.persisted) noBack();" onUnload="">
	
	<!-- Navigation Bar
    ================================================== -->
	<nav class="navbar navbar-inverse" data-spy="affix" data-offset-top="197" id="navigationColour">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>                        
				</button>
				<img src="avatars/logo.png" alt="logo" id="Logo">
				<p class="navbar-brand">Cards Against University : Judging Panel</p>
			</div>
    
			<div>
				<div class="collapse navbar-collapse" id="myNavbar">
					<!-- Navigation options centered 				Can center "Judging Panel"
					<ul class="nav navbar-nav">
						<li><a href="#">Judging Panel</a></li>
					</ul>-->
					
					<!-- Navigation option to the right -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="#">Quit</a></li>
						<li class="dropdown navbar-right" id="profile"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Profile <span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li><a href="#">Current credits</a></li>
								<li><a href="#">Coin counter</a></li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</nav><!-- ./navigation Bar -->    
	
	
	<!-- HTML for Black Scenario card -->
  <div class="container-fluid"> <!--Black card and timer are wrapped in this container-->

    <div class="col-sm-10" id="bCard">  <!--Black card and submit button are in this col (Responsive)-->
      <center>
        <canvas id="myBlackCanvas" width="0" height="0">
          Your browser does not support the HTML5 canvas tag.
        </canvas>
      </center>
    </div>

    </div>
    
    <!-- Block buttons 
    =======================================================-->
    <div class="container">
    <center>
      <h3>Pick the Winner!</h3>
    </center>
      <button type="button" class="btn btn-primary btn-md btn-block"  onclick="selectedAnswer(1)" data-toggle="modal" data-target="#myModal"><label id="s1" for="subOpt1"></label></button>
      <button type="button" class="btn btn-default btn-md btn-block"  onclick="selectedAnswer(2)" data-toggle="modal" data-target="#myModal"><label id="s2" for="subOpt2"></label></button>
      <button type="button" class="btn btn-primary btn-md btn-block"  onclick="selectedAnswer(3)" data-toggle="modal" data-target="#myModal"><label id="s3" for="subOpt3"></label></button>
      <button type="button" class="btn btn-default btn-md btn-block"  onclick="selectedAnswer(4)" data-toggle="modal" data-target="#myModal"><label id="s4" for="subOpt4"></label></button>
      <button type="button" class="btn btn-primary btn-md btn-block"  onclick="selectedAnswer(5)" data-toggle="modal" data-target="#myModal"><label id="s5" for="subOpt5"></label></button>

      <br>

      <div id="space"></div>
	
	<!-- modal code 
		===============================  -->
		
<div class="container">
	<div id="myModal" class="modal fade" role="dialog" data-keyboard="false" data-backdrop="static">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
       <div id = "timer2"></div>
        <h4 class="modal-title">Confirmation</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to choose this answer?</p>
      </div>
      <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal" data-toggle="modal" data-target="#myModal2">Yes</button>
  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
    </div>      
    </div>
  	</div>
    </div>
  </div>

  <div class="container">
  <div id="myModal2" class="modal fade" role="dialog" data-keyboard="false" data-backdrop="static">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
       <div id = "timer2"></div>
        <h4 class="modal-title">Your vote has been submitted</h4>
      </div>
      <div class="modal-body">
        <p>Waiting for other players to submit their vote</p>
      </div>     
    </div>
    </div>
    </div>
  </div>

  <script>
  var GameRef = "";
  var ans = "";
  
    var timeLeft = 30;
    
    var elem2 = document.getElementById('timer2');
    var timerId = setInterval(countdown, 1000);
    function countdown() {
      if (timeLeft == 0) {
        clearTimeout(timerId);

        location.href="resultpage.html"
                
      } else {
        
        elem2.innerHTML = timeLeft + ' seconds remaining';
        timeLeft--;
      }
    }


    <!-- ========== BLACK CANVAS CARD ========== -->
    var blockSize = 40;         //the num of pixels per block
    var canvasWidth = blockSize * 5;  //the num of blocks across
    var canvasHeight = blockSize * 7; //the numb of blocks down 
    
    <!--Set up Black Card CANVAS-->
    var b = document.getElementById("myBlackCanvas");
    b.width = canvasWidth;        //set size of black card
    b.height = canvasHeight;
    
    var ctxBlack = b.getContext("2d");  //get black card context
    ctxBlack.fillStyle = "#000";  //fill background black
    ctxBlack.fillRect(s(0),s(0),s(5),s(7)); //fill the entire canvas (black)
    ctxBlack.font = "20px Helvetica";   //font
    ctxBlack.fillStyle = '#FFF';      //font colour
    ctxBlack.textAlign = 'center';      //center text on black card
            
          
    //Pull text from Firebase
    var blck = localStorage.getItem("CurrBlkCrd");
    console.log(blck);
    var ref = new Firebase("https://cau-maynooth.firebaseio.com/blackCards/" + blck);
    console.log(ref);
    ref.once("value", function(snapshot) {
        var scenarioCard = snapshot.val();
        console.log("Message from server; ", scenarioCard);
    
    //wrapText fits long inputs (mulit-line) on the card nicely
        wrapText(ctxBlack, scenarioCard, s(2.5), s(2), s(4), 20);
    },
        function (errorObject) {  // Deal with errors
          console.log("The read failed: " + errorObject.code);
        });
    
    // s() scales everything to size according to the set blocksize
    function s(x) {
      return x*blockSize-1;
    }

    //method to generate random number
    function randNum(){
      return Math.floor((Math.random() * 6) + 1);
      }

    function wrapText(context, text, x, y, maxWidth, lineHeight) {
      console.log("text = " , text);
        var words = text.split(' ');          //split text into array

        var line = '';                  

        for(var n = 0; n < words.length; n++) {     
          var testLine = line + words[n] + ' ';
          var metrics = context.measureText(testLine);
          var testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            context.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
          }
          else {
            line = testLine;
          }
        }
        context.fillText(line, x, y);
      }

    // --> 

    //Javascript for voting submission
    

            GameRef = localStorage.getItem("GameRef"); //get the game reference from previous page to pull data down from database
            var counter = 1; // Variable to store the count
            var vals = ""; // Stores the data object returned from Firebase
            var trsfAns = ""; //Stores the ChosenAnswer value from the object specifically 

            var ref = new Firebase("https://cau-maynooth.firebaseio.com/Game/Game " + GameRef); // Store a link to location of current game
            ref.on("child_added", function(snapshot, prevChildKey) { // Used like a for each loop to check each child node at path
                    vals = snapshot.val(); // Store returned ojbect in a variable
                    trsfAns = vals.ChosenAnswer; // Store the specific chosen answer value in a variable
                    document.getElementsByTagName('button')[counter].textContent = trsfAns; // Display the answer on the html page
                    counter++; 
                    
            });

    function selectedAnswer(num){ // Called on user vote
        
        var usersRef = new Firebase("https://cau-maynooth.firebaseio.com/Judging"); // ref to Firebase
        var authData = usersRef.getAuth(); // Store current users UID
        var numOfPlayers = ""; // Kepps track of the number of current players

        switch (num) { // Switch statement to store the phrase/sentence current user wants to vote for
            case 1:
                ans = document.getElementsByTagName('button')[num].textContent;
                break;
            case 2:
                ans = document.getElementsByTagName('button')[num].textContent;
                break;
            case 3:
                ans = document.getElementsByTagName('button')[num].textContent;
                break;
            case 4:
                ans = document.getElementsByTagName('button')[num].textContent;
                break;
            case 5:
                ans = document.getElementsByTagName('button')[num].textContent;
                break;
        }

        //AJAX sends the php request to MySQL table when choice is made
          
            //document.getElementById("myModal").showModal(); 
            GameRef = "Game " + GameRef;
            var fireUID = getUID();     //get the firebaseUID
            var xhttp = new XMLHttpRequest();     //make a new request object

            xhttp.onreadystatechange = function(){      //if the response/php is successful, change page
              if(xhttp.readyState == 4 && xhttp.status == 200){
                document.getElementById('echoRes').innerHTML = xhttp.responseText;
              } 
            };
            xhttp.open("POST", "results.php", true);      //wrap the request in POST
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // Need this as posting data to SQL table
            xhttp.send("fireUID="+fireUID+"&vote="+ans+"&GameNumber="+GameRef);  //send the user details in the request to the PHP page
            console.log("hello");

            
               
      }

    //special function just to get the user's FirebaseUID after they have registered
  function getUID(){
      var myDataRef = new Firebase('hhttps://cau-maynooth.firebaseio.com');
    var authData = myDataRef.getAuth();
    return authData.uid;
  }
  
  </script>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="../../dist/js/bootstrap.min.js"></script>
    <script src="../../assets/js/vendor/holder.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>
        
  </body>
</html>
